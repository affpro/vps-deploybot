name: Cleanup Docker on VPS

on:
  workflow_dispatch:  # Allows manual trigger from GitHub Actions

jobs:
  cleanup-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH Key ðŸ”‘
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      - name: Cleanup Docker on VPS
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "ðŸ›‘ Stopping all Docker containers..."
            sudo docker stop $(docker ps -aq) 2>/dev/null || echo "No running containers."

            echo "ðŸ—‘ Removing all Docker containers..."
            sudo docker rm $(docker ps -aq) 2>/dev/null || echo "No containers to remove."

            echo "ðŸ“¦ Removing all Docker images..."
            sudo docker rmi $(docker images -q) -f 2>/dev/null || echo "No images to remove."

            echo "ðŸ“‚ Removing all Docker volumes..."
            sudo docker volume rm $(docker volume ls -q) -f 2>/dev/null || echo "No volumes to remove."

            echo "ðŸ§¹ Removing unused Docker networks..."
            sudo docker network prune -f 2>/dev/null || echo "No networks to prune."

            echo "ðŸ—‘ Clearing unused Docker system resources..."
            sudo docker system prune -af --volumes 2>/dev/null || echo "Nothing to clean up."

            echo "âœ… Docker cleanup complete!"
          EOF
